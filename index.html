<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>쏘카 미디어리스트</title>
<link href="https://fonts.googleapis.com/css2?family=Pretendard:wght@300;400;500;600;700&family=DM+Mono:wght@400;500&display=swap" rel="stylesheet">
<style>
:root {
  --bg:#0f1117;--surface:#1a1d27;--surface2:#22263a;--border:#2e3350;
  --accent:#4f8eff;--accent2:#ff6b6b;--accent3:#63e6be;
  --text:#e8ecf4;--text2:#8b92a8;--text3:#545b73;
  --active-bg:#162340;--inactive-bg:#1c1822;
}
*{box-sizing:border-box;margin:0;padding:0;}
body{font-family:'Pretendard',sans-serif;background:var(--bg);color:var(--text);min-height:100vh;font-size:14px;}

/* HEADER */
.header{display:flex;align-items:center;justify-content:space-between;padding:14px 28px;border-bottom:1px solid var(--border);background:var(--surface);position:sticky;top:0;z-index:100;}
.header-left{display:flex;align-items:center;gap:12px;}
.logo-img{height:36px;object-fit:contain;display:block;}
.logo-label{font-size:15px;font-weight:700;color:#fff;letter-spacing:2px;height:36px;line-height:36px;}
.header-count{font-size:12px;color:var(--text2);background:var(--surface2);border:1px solid var(--border);padding:3px 10px;border-radius:20px;}
.header-count span{color:var(--accent);font-weight:600;}

/* TOOLBAR */
.toolbar{display:flex;align-items:center;gap:8px;padding:12px 28px;background:var(--surface);border-bottom:1px solid var(--border);flex-wrap:wrap;}
.search-wrap{position:relative;flex:1;min-width:220px;max-width:360px;}
.search-wrap svg{position:absolute;left:10px;top:50%;transform:translateY(-50%);color:var(--text3);pointer-events:none;}
.search-input{width:100%;background:var(--bg);border:1px solid var(--border);border-radius:8px;padding:8px 12px 8px 32px;color:var(--text);font-family:inherit;font-size:13px;outline:none;transition:border-color .15s;}
.search-input:focus{border-color:var(--accent);}
.search-input::placeholder{color:var(--text3);}
.filter-group{display:flex;gap:5px;flex-wrap:wrap;}
.filter-btn{padding:6px 13px;border-radius:6px;border:1px solid var(--border);background:transparent;color:var(--text2);font-family:inherit;font-size:12px;cursor:pointer;transition:all .15s;white-space:nowrap;}
.filter-btn:hover{border-color:var(--accent);color:var(--accent);}
.filter-btn.active{background:rgba(79,142,255,0.15);border-color:var(--accent);color:var(--accent);}
.separator{width:1px;height:24px;background:var(--border);flex-shrink:0;}
.status-btn{padding:6px 13px;border-radius:6px;border:1px solid var(--border);background:transparent;color:var(--text2);font-family:inherit;font-size:12px;cursor:pointer;transition:all .15s;white-space:nowrap;}
.status-btn.active-filter{background:rgba(99,230,190,0.12);border-color:var(--accent3);color:var(--accent3);}
.status-btn.inactive-filter{background:rgba(255,107,107,0.12);border-color:var(--accent2);color:var(--accent2);}
.add-btn{margin-left:auto;padding:8px 16px;background:var(--accent);border:none;border-radius:8px;color:#fff;font-family:inherit;font-size:13px;font-weight:600;cursor:pointer;transition:opacity .15s;display:flex;align-items:center;gap:5px;white-space:nowrap;}
.add-btn:hover{opacity:.85;}
.refresh-btn{margin-left:8px;padding:8px 12px;background:var(--surface2);border:1px solid var(--border);border-radius:8px;color:var(--text2);cursor:pointer;display:flex;align-items:center;gap:5px;transition:all .15s;}
.refresh-btn:hover{border-color:var(--accent);color:var(--accent);}

/* MAIN */
.main{padding:18px 28px;}

/* MEDIA GROUP */
.media-group{margin-bottom:18px;}
.media-header{display:flex;align-items:center;gap:10px;padding:10px 14px;background:var(--surface2);border:1px solid var(--border);border-radius:8px 8px 0 0;cursor:pointer;user-select:none;}
.media-type-tag{font-size:10px;font-weight:700;padding:2px 8px;border-radius:4px;letter-spacing:.5px;flex-shrink:0;}
.tag-종합지{background:rgba(79,142,255,0.15);color:#7ab3ff;border:1px solid rgba(79,142,255,0.3);}
.tag-경제지{background:rgba(99,230,190,0.12);color:#63e6be;border:1px solid rgba(99,230,190,0.25);}
.tag-인터넷{background:rgba(255,200,60,0.12);color:#ffc83c;border:1px solid rgba(255,200,60,0.25);}
.tag-통신사{background:rgba(180,100,255,0.12);color:#c478ff;border:1px solid rgba(180,100,255,0.25);}
.tag-IT\/스타트업,.tag-IT스타트업{background:rgba(255,170,50,0.12);color:#ffaa32;border:1px solid rgba(255,170,50,0.25);}
.tag-방송{background:rgba(255,100,150,0.12);color:#ff6496;border:1px solid rgba(255,100,150,0.25);}
.tag-주간지\/월간지,.tag-IT스타트업{background:rgba(20,184,166,0.12);color:#14b8a6;border:1px solid rgba(20,184,166,0.28);}
.tag-기타{background:rgba(150,150,180,0.12);color:#a0a0c0;border:1px solid rgba(150,150,180,0.25);}
.media-name{font-size:14px;font-weight:600;}
.media-count{font-size:11px;color:var(--text3);margin-left:auto;}
.chevron{color:var(--text3);font-size:11px;transition:transform .2s;flex-shrink:0;}
.chevron.open{transform:rotate(180deg);}

/* TABLE */
.table-wrap{border:1px solid var(--border);border-top:none;border-radius:0 0 8px 8px;overflow:hidden;}
.table-wrap.collapsed{display:none;}
table{width:100%;border-collapse:collapse;table-layout:fixed;}
thead th{padding:8px 10px;background:rgba(15,17,23,.95);font-size:11px;font-weight:600;color:var(--text3);text-align:left;letter-spacing:.4px;border-bottom:1px solid var(--border);white-space:nowrap;overflow:hidden;}
tbody tr{border-bottom:1px solid rgba(46,51,80,.4);transition:background .1s;}
tbody tr:last-child{border-bottom:none;}
tbody tr:hover{background:rgba(79,142,255,.04);}
tbody tr.row-inactive{opacity:.6;}
tbody tr.row-inactive:hover{opacity:.8;}
td{padding:9px 10px;font-size:13px;color:var(--text);vertical-align:middle;overflow:hidden;}
td.td-dept{color:var(--text2);font-size:12px;}
td.td-name{font-weight:600;}

/* COL WIDTHS */
.col-dept{width:130px;}
.col-name{width:120px;}
.col-email{width:160px;min-width:100px;max-width:160px;}
.col-phone{width:130px;}
.col-send{width:90px;}
.col-history{width:150px;}
.col-memo{width:160px;}
.col-status{width:80px;}
.col-actions{width:70px;}

/* EMAIL TAGS */
.email-cell{display:flex;flex-direction:column;gap:3px;}
.email-tag{display:inline-flex;align-items:center;gap:4px;background:var(--surface2);border:1px solid var(--border);border-radius:5px;padding:2px 8px;font-family:'DM Mono',monospace;font-size:11px;color:var(--text2);cursor:pointer;transition:all .12s;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:170px;display:block;}
.email-tag:hover{border-color:var(--accent);color:var(--accent);background:rgba(79,142,255,.08);}
.email-tag.copied{border-color:var(--accent3);color:var(--accent3);}

/* PHONE */
.phone-tag{display:inline-flex;align-items:center;font-family:'DM Mono',monospace;font-size:12px;color:var(--text2);cursor:pointer;padding:2px 6px;border-radius:5px;border:1px solid transparent;transition:all .12s;white-space:nowrap;}
.phone-tag:hover{border-color:var(--accent);color:var(--accent);}
.phone-tag.copied{border-color:var(--accent3);color:var(--accent3);}

/* SEND FLAGS */
.send-flags{display:flex;flex-direction:column;gap:4px;}
.send-flag{display:inline-flex;align-items:center;gap:4px;font-size:11px;font-weight:500;padding:2px 7px;border-radius:4px;}
.flag-email-on{background:rgba(79,142,255,.12);color:var(--accent);border:1px solid rgba(79,142,255,.25);}
.flag-sms-on{background:rgba(99,230,190,.1);color:var(--accent3);border:1px solid rgba(99,230,190,.2);}

/* HISTORY PILLS */
.hist-pill{display:inline-flex;align-items:center;gap:3px;font-size:10px;font-family:'DM Mono',monospace;padding:2px 6px;border-radius:4px;}
.hist-join{background:rgba(99,230,190,.08);color:var(--accent3);border:1px solid rgba(99,230,190,.15);}
.hist-leave{background:rgba(255,107,107,.08);color:var(--accent2);border:1px solid rgba(255,107,107,.15);}
.hist-wrap{display:flex;flex-wrap:wrap;gap:3px;align-items:center;}

/* STATUS */
.status-badge{display:inline-flex;align-items:center;gap:4px;font-size:11px;font-weight:600;padding:3px 9px;border-radius:12px;cursor:pointer;transition:all .15s;border:1px solid transparent;white-space:nowrap;}
.badge-active{background:rgba(99,230,190,.1);color:var(--accent3);border-color:rgba(99,230,190,.2);}
.badge-inactive{background:rgba(255,107,107,.1);color:var(--accent2);border-color:rgba(255,107,107,.2);}
.status-badge:hover{opacity:.75;}

/* ICON BTNS */
.row-actions{display:flex;gap:3px;}
.icon-btn{width:26px;height:26px;display:flex;align-items:center;justify-content:center;border-radius:6px;border:1px solid var(--border);background:transparent;color:var(--text3);cursor:pointer;transition:all .12s;font-size:12px;}
.icon-btn:hover{border-color:var(--accent);color:var(--accent);background:rgba(79,142,255,.08);}

/* MODAL */
.modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,.75);display:flex;align-items:center;justify-content:center;z-index:1000;backdrop-filter:blur(4px);}
.modal{background:var(--surface);border:1px solid var(--border);border-radius:14px;padding:26px;width:560px;max-width:96vw;max-height:92vh;overflow-y:auto;}
.modal-title{font-size:16px;font-weight:700;margin-bottom:20px;}
.form-grid{display:grid;grid-template-columns:1fr 1fr;gap:13px;}
.form-field{display:flex;flex-direction:column;gap:5px;}
.form-field.full{grid-column:1/-1;}
.form-label{font-size:11px;font-weight:600;color:var(--text3);letter-spacing:.5px;}
.form-input,.form-select,.form-textarea{background:var(--bg);border:1px solid var(--border);border-radius:7px;padding:8px 11px;color:var(--text);font-family:inherit;font-size:13px;outline:none;transition:border-color .15s;}
.form-input:focus,.form-select:focus,.form-textarea:focus{border-color:var(--accent);}
.form-textarea{resize:vertical;min-height:68px;}
.form-select option{background:var(--surface2);}
.modal-actions{display:flex;gap:10px;justify-content:flex-end;margin-top:20px;}
.btn-cancel{padding:8px 18px;background:transparent;border:1px solid var(--border);border-radius:8px;color:var(--text2);font-family:inherit;font-size:13px;cursor:pointer;}
.btn-cancel:hover{border-color:var(--text2);}
.btn-save{padding:8px 20px;background:var(--accent);border:none;border-radius:8px;color:#fff;font-family:inherit;font-size:13px;font-weight:600;cursor:pointer;}
.btn-save:hover{opacity:.85;}

/* EMAIL LIST IN FORM */
.email-list{display:flex;flex-direction:column;gap:6px;}
.email-row{display:flex;gap:6px;align-items:center;}
.email-row .form-input{flex:1;}
.btn-remove-email{width:28px;height:28px;display:flex;align-items:center;justify-content:center;border-radius:6px;border:1px solid var(--border);background:transparent;color:var(--text3);cursor:pointer;font-size:14px;flex-shrink:0;}
.btn-remove-email:hover{border-color:var(--accent2);color:var(--accent2);}
.btn-add-email{padding:5px 12px;background:var(--surface2);border:1px solid var(--border);border-radius:6px;color:var(--text2);font-family:inherit;font-size:12px;cursor:pointer;margin-top:2px;width:fit-content;}
.btn-add-email:hover{border-color:var(--accent);color:var(--accent);}

/* SEND TOGGLE BUTTONS */
.send-toggle-row{display:flex;gap:8px;}
.send-toggle{display:flex;align-items:center;gap:6px;padding:7px 14px;border-radius:8px;border:1px solid var(--border);background:var(--bg);color:var(--text2);font-family:inherit;font-size:13px;font-weight:500;cursor:pointer;transition:all .15s;user-select:none;}
.send-toggle:hover{border-color:var(--text3);}
.send-toggle.on-email{background:rgba(79,142,255,.12);border-color:var(--accent);color:var(--accent);}
.send-toggle.on-sms{background:rgba(99,230,190,.1);border-color:var(--accent3);color:var(--accent3);}
.send-toggle .dot{width:7px;height:7px;border-radius:50%;background:currentColor;opacity:.5;transition:opacity .15s;}
.send-toggle.on-email .dot,.send-toggle.on-sms .dot{opacity:1;}

/* HISTORY MODAL */
.hist-modal-entries{display:flex;flex-direction:column;gap:7px;margin:14px 0;}
.hist-modal-entry{display:flex;align-items:center;gap:9px;padding:9px 12px;background:var(--bg);border-radius:8px;border:1px solid var(--border);}
.hist-dot{width:8px;height:8px;border-radius:50%;flex-shrink:0;}
.dot-join{background:var(--accent3);}
.dot-leave{background:var(--accent2);}
.hist-date{font-family:'DM Mono',monospace;font-size:12px;color:var(--text2);min-width:90px;}
.hist-type-label{font-size:11px;font-weight:700;}
.type-join{color:var(--accent3);}
.type-leave{color:var(--accent2);}
.hist-note{font-size:12px;color:var(--text3);flex:1;}
.add-hist-row{display:flex;gap:7px;align-items:center;margin-top:4px;}
.add-hist-row input,.add-hist-row select{background:var(--bg);border:1px solid var(--border);border-radius:7px;padding:7px 10px;color:var(--text);font-family:inherit;font-size:12px;outline:none;}
.add-hist-row input:focus,.add-hist-row select:focus{border-color:var(--accent);}
.btn-add-hist{padding:7px 13px;background:var(--surface2);border:1px solid var(--border);border-radius:7px;color:var(--text2);font-family:inherit;font-size:12px;cursor:pointer;white-space:nowrap;}
.btn-add-hist:hover{border-color:var(--accent);color:var(--accent);}

/* TOAST */
.toast{position:fixed;bottom:24px;left:50%;transform:translateX(-50%) translateY(10px);background:var(--surface2);border:1px solid var(--border);border-radius:8px;padding:10px 20px;font-size:13px;z-index:9999;opacity:0;transition:all .2s;pointer-events:none;}
.toast.show{opacity:1;transform:translateX(-50%) translateY(0);}
.no-results{text-align:center;padding:60px;color:var(--text3);}

/* LOADING OVERLAY */
.loading-overlay{position:fixed;inset:0;background:rgba(15,17,23,.85);display:flex;flex-direction:column;align-items:center;justify-content:center;z-index:99999;backdrop-filter:blur(3px);}
.spinner{border:4px solid rgba(79,142,255,.2);border-top:4px solid var(--accent);border-radius:50%;width:36px;height:36px;animation:spin 1s linear infinite;margin-bottom:14px;}
@keyframes spin{0%{transform:rotate(0deg);}100%{transform:rotate(360deg);}}
#loadingText{color:var(--text);font-size:14px;font-weight:500;letter-spacing:0.5px;}

/* COPY ROW BTN */
.copy-row-btn{display:inline-flex;align-items:center;gap:4px;padding:3px 8px;border-radius:5px;border:1px solid var(--border);background:transparent;color:var(--text3);font-size:11px;cursor:pointer;transition:all .12s;}
.copy-row-btn:hover{border-color:var(--accent3);color:var(--accent3);}
</style>
</head>
<body>

<div class="header">
  <div class="header-left">
  <span class="logo-label">SOCAR MEDIA LIST</span>
  <span class="header-count">출입 <span id="active-count">0</span>명</span>
</div>
</div>

<div class="toolbar">
  <div class="search-wrap">
    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.35-4.35"/></svg>
    <input class="search-input" id="searchInput" placeholder="기자명, 매체명, 이메일, 전화번호 검색..." oninput="render()">
  </div>
  <div class="filter-group" id="typeFilters"></div>
  <div class="separator"></div>
  <button class="status-btn" id="btnActive" onclick="toggleStatus('active')">● 출입</button>
  <button class="status-btn" id="btnInactive" onclick="toggleStatus('inactive')">○ 제외</button>
  <button class="add-btn" onclick="openAddModal()">
    <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M12 5v14M5 12h14"/></svg>기자 추가
  </button>
  <button class="refresh-btn" onclick="loadData()">
    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21.5 2v6h-6M21.34 15.57a10 10 0 1 1-.59-9.21l-5.46 5.46"/></svg>새로고침
  </button>
</div>

<div class="main" id="mainContent"></div>

<div class="modal-overlay" id="editModal" style="display:none" onclick="if(event.target===this)closeEditModal()">
<div class="modal">
  <div class="modal-title" id="modalTitle">기자 추가</div>
  <div class="form-grid">
    <div class="form-field">
      <label class="form-label">매체타입</label>
      <select class="form-select" id="f-type">
        <option>종합지</option><option>경제지</option><option>통신사</option>
        <option>인터넷</option><option>IT/스타트업</option><option>방송</option><option>주간지/월간지</option><option>기타</option>
      </select>
    </div>
    <div class="form-field">
      <label class="form-label">매체명</label>
      <input class="form-input" id="f-media" list="media-datalist" placeholder="매체명">
      <datalist id="media-datalist"></datalist>
    </div>
    <div class="form-field">
      <label class="form-label">부서/담당</label>
      <input class="form-input" id="f-dept" placeholder="예: 테크부">
    </div>
    <div class="form-field">
      <label class="form-label">기자명 *</label>
      <input class="form-input" id="f-name" placeholder="홍길동 기자">
    </div>
    <div class="form-field full">
      <label class="form-label">이메일 (여러 개 추가 가능)</label>
      <div class="email-list" id="email-list"></div>
      <button class="btn-add-email" onclick="addEmailField()">+ 이메일 추가</button>
    </div>
    <div class="form-field">
      <label class="form-label">전화번호</label>
      <input class="form-input" id="f-phone" placeholder="010-0000-0000">
    </div>
    <div class="form-field">
      <label class="form-label">출입일</label>
      <input class="form-input" id="f-date" type="date">
    </div>
    <div class="form-field full">
      <label class="form-label">발송 채널</label>
      <div class="send-toggle-row">
        <button type="button" class="send-toggle" id="f-emailSend" onclick="toggleSend('f-emailSend','on-email')"><span class="dot"></span>이메일</button>
        <button type="button" class="send-toggle" id="f-smsSend" onclick="toggleSend('f-smsSend','on-sms')"><span class="dot"></span>문자</button>
      </div>
    </div>
    <div class="form-field full">
      <label class="form-label">메모</label>
      <textarea class="form-textarea" id="f-memo" placeholder="담당 분야, 특이사항 등..."></textarea>
    </div>
  </div>
  <div class="modal-actions">
    <button class="btn-cancel" onclick="closeEditModal()">취소</button>
    <button class="btn-save" onclick="saveJournalist()">저장</button>
  </div>
</div>
</div>

<div class="modal-overlay" id="histModal" style="display:none" onclick="if(event.target===this)closeHistModal(true)">
<div class="modal" style="max-width:460px">
  <div class="modal-title" id="histModalTitle">출입 이력</div>
  <div class="hist-modal-entries" id="histEntries"></div>
  <div class="add-hist-row">
    <select id="h-type"><option value="join">출입</option><option value="leave">제외</option></select>
    <input type="date" id="h-date">
    <input type="text" id="h-note" placeholder="메모" style="flex:1">
    <button class="btn-add-hist" onclick="addHistEntry()">추가</button>
  </div>
  <div class="modal-actions">
    <button class="btn-save" onclick="closeHistModal(true)">완료</button>
  </div>
</div>
</div>

<div id="loadingOverlay" class="loading-overlay" style="display:none;">
  <div class="spinner"></div>
  <div id="loadingText">데이터를 불러오는 중입니다...</div>
</div>

<div class="toast" id="toast"></div>

<script>
// ★ 방금 발급받은 URL을 여기에 넣습니다.
const API_URL = "https://script.google.com/macros/s/AKfycbxtB2oTkcWboVkgBDByDqRbXxPVWaVGyuVx3L4acxlhCDpPRP8PwzZJpdUNn_Bmpyk4-w/exec";

let data = [];
let nextId = 1;

const MEDIA_TYPES = ["종합지","경제지","통신사","인터넷","IT/스타트업","방송","주간지/월간지","기타"];
let typeFilter = null;
let statusFilter = null;
let editingId = null;
let histEditingId = null;

// ── 데이터 로딩 ─────────────────────────────────────
function showLoading(msg = '로딩 중...') {
  document.getElementById('loadingText').textContent = msg;
  document.getElementById('loadingOverlay').style.display = 'flex';
}
function hideLoading() {
  document.getElementById('loadingOverlay').style.display = 'none';
}

async function loadData() {
  showLoading('구글 시트에서 최신 데이터를 불러오는 중입니다...');
  try {
    const res = await fetch(API_URL);
    data = await res.json();
    if (data.length > 0) {
      nextId = Math.max(...data.map(d => parseInt(d.id) || 0)) + 1;
    }
    initFilters();
    render();
  } catch (error) {
    alert('데이터를 불러오지 못했습니다. 네트워크 상태를 확인해주세요.');
  } finally {
    hideLoading();
  }
}

// ── FILTER ─────────────────────────────────────────
function getFiltered() {
  const q = document.getElementById('searchInput').value.trim().toLowerCase();
  return data.filter(j => {
    if (typeFilter && j.mediaType !== typeFilter) return false;
    if (statusFilter === 'active' && !j.active) return false;
    if (statusFilter === 'inactive' && j.active) return false;
    if (!q) return true;
    return (j.name||'').toLowerCase().includes(q) ||
      (j.mediaName||'').toLowerCase().includes(q) ||
      (j.dept||'').toLowerCase().includes(q) ||
      (j.emails||[]).some(e=>e.toLowerCase().includes(q)) ||
      (j.phone||'').includes(q) ||
      (j.memo||'').toLowerCase().includes(q);
  });
}

// ── RENDER ─────────────────────────────────────────
function render() {
  const filtered = getFiltered();
  document.getElementById('total-count').textContent = data.length;
  document.getElementById('active-count').textContent = data.filter(d=>d.active).length;

  const main = document.getElementById('mainContent');
  if (!filtered.length) { main.innerHTML = '<div class="no-results">검색 결과가 없습니다.</div>'; return; }

  const groupMap = new Map();
  filtered.forEach(j => {
    const key = j.sheetOrder + '||'  + j.mediaOrder + '||' + j.mediaType + '||' + j.mediaName;
    if (!groupMap.has(key)) groupMap.set(key, {sheetOrder:j.sheetOrder, mediaOrder:j.mediaOrder, mediaType:j.mediaType, mediaName:j.mediaName, list:[]});
    groupMap.get(key).list.push(j);
  });

  const groups = [...groupMap.values()].sort((a,b) => a.sheetOrder !== b.sheetOrder ? a.sheetOrder - b.sheetOrder : a.mediaOrder - b.mediaOrder);

  let html = '';
  groups.forEach(g => {
    const active = g.list.filter(j=>j.active);
    const inactive = g.list.filter(j=>!j.active);
    const sorted = [...active, ...inactive];

    const activeCount = active.length;
    const totalCount = sorted.length;
    const tagClass = 'tag-' + g.mediaType.replace('/','/');
    const gKey = encodeURIComponent(g.sheetOrder+'_'+g.mediaOrder+'_'+g.mediaName);

    html += `<div class="media-group">
      <div class="media-header" onclick="toggleGroup('${gKey}')">
        <span class="media-type-tag ${tagClass}">${g.mediaType}</span>
        <span class="media-name">${g.mediaName}</span>
        <span class="media-count">${activeCount}/${totalCount}명</span>
        <span class="chevron open" id="chev-${gKey}">▾</span>
      </div>
      <div class="table-wrap" id="grp-${gKey}">
        <table>
          <colgroup>
            <col class="col-dept"><col class="col-name"><col class="col-email">
            <col class="col-phone"><col class="col-send"><col class="col-history">
            <col class="col-memo"><col class="col-status"><col class="col-actions">
          </colgroup>
          <thead><tr>
            <th>부서/담당</th><th>기자명</th><th>이메일</th><th>전화번호</th>
            <th>발송</th><th>출입 이력</th><th>메모</th><th>상태</th><th></th>
          </tr></thead>
          <tbody>`;

    sorted.forEach(j => {
      const iClass = j.active ? '' : 'row-inactive';

      const emailsHtml = (j.emails||[]).length
        ? (j.emails||[]).map(e => `<span class="email-tag" onclick="copyText('${e.replace(/'/g,"\'")}',this)">${e}</span>`).join('')
        : '<span style="color:var(--text3);font-size:12px">—</span>';

      const ef = j.emailSend ? '<span class="send-flag flag-email-on">✉ 이메일</span>' : '';
      const sf = j.smsSend ? '<span class="send-flag flag-sms-on">✆ 문자</span>' : '';
      const sendHtml = (ef||sf) ? `<div class="send-flags">${ef}${sf}</div>` : '<span style="color:var(--text3);font-size:12px">—</span>';

      const last2 = (j.history||[]).slice(-2);
      const histHtml = `<div class="hist-wrap">
        ${last2.map(h=>`<span class="hist-pill ${h.type==='join'?'hist-join':'hist-leave'}">${h.type==='join'?'↑':'↓'} ${h.date}</span>`).join('')}
        ${(j.history||[]).length>2?`<span style="font-size:10px;color:var(--text3)">+${(j.history||[]).length-2}</span>`:''}
        <button class="icon-btn" onclick="openHistModal(${j.id})" title="이력" style="width:22px;height:22px;font-size:10px">≡</button>
      </div>`;

      const statusHtml = `<span class="status-badge ${j.active?'badge-active':'badge-inactive'}" onclick="toggleActive(${j.id})">${j.active?'● 출입':'○ 제외'}</span>`;

      html += `<tr class="${iClass}">
        <td class="td-dept">${j.dept||''}</td>
        <td class="td-name">${j.name}</td>
        <td><div class="email-cell">${emailsHtml}</div></td>
        <td>${j.phone ? `<span class="phone-tag" onclick="copyText('${j.phone}',this)">${j.phone}</span>` : '<span style="color:var(--text3);font-size:12px">—</span>'}</td>
        <td>${sendHtml}</td>
        <td>${histHtml}</td>
        <td style="font-size:12px;color:var(--text2)">${j.memo||''}</td>
        <td>${statusHtml}</td>
        <td><div class="row-actions">
          <button class="icon-btn" onclick="copyRow(${j.id})" title="복사">⎘</button>
          <button class="icon-btn" onclick="openEditModal(${j.id})" title="편집">✎</button>
        </div></td>
      </tr>`;
    });
    html += '</tbody></table></div></div>';
  });
  main.innerHTML = html;
}

// ── TOGGLE GROUP ────────────────────────────────────
function toggleGroup(key) {
  const el = document.getElementById('grp-'+key);
  const ch = document.getElementById('chev-'+key);
  if (!el) return;
  el.classList.toggle('collapsed');
  ch.classList.toggle('open');
}

// ── 구글 시트 전송 공통 함수 ───────────────────────────
async function saveToGoogleSheet(action, item) {
  try {
    await fetch(API_URL, {
      method: 'POST',
      headers: { 'Content-Type': 'text/plain;charset=utf-8' },
      body: JSON.stringify({ action: action, data: item })
    });
  } catch (e) {
    console.error(e);
    alert('저장 중 서버 통신 에러가 발생했습니다.');
  }
}

// ── TOGGLE ACTIVE ───────────────────────────────────
async function toggleActive(id) {
  const j = data.find(d=>d.id===id);
  if (!j) return;
  
  showLoading('상태를 변경하고 저장 중입니다...');
  
  j.active = !j.active;
  const today = new Date().toISOString().slice(0,10);
  j.history = j.history || [];
  j.history.push({type: j.active ? 'join' : 'leave', date: today, note: j.active ? '출입 복귀' : '제외 처리'});
  
  await saveToGoogleSheet('edit', j);
  
  render();
  hideLoading();
  showToast(j.active ? `${j.name} 출입 복귀` : `${j.name} 제외 처리됨`);
}

// ── COPY ────────────────────────────────────────────
function copyText(text, el) {
  navigator.clipboard.writeText(text).then(() => {
    const orig = el.textContent;
    el.classList.add('copied');
    el.textContent = '복사됨';
    setTimeout(() => { el.classList.remove('copied'); el.textContent = orig; }, 1400);
  });
}
function copyRow(id) {
  const j = data.find(d=>d.id===id);
  if (!j) return;
  const text = j.name + '\t' + (j.emails||[]).join(', ') + '\t' + j.phone;
  navigator.clipboard.writeText(text).then(() => showToast(`${j.name} 정보 복사됨`));
}

function showToast(msg) {
  const t = document.getElementById('toast');
  t.textContent = msg;
  t.classList.add('show');
  setTimeout(() => t.classList.remove('show'), 2400);
}

// ── TYPE FILTERS ─────────────────────────────────────
function initFilters() {
  const wrap = document.getElementById('typeFilters');
  let h = '<button class="filter-btn active" id="tf-all" onclick="setTypeFilter(null)">전체</button>';
  MEDIA_TYPES.forEach(t => h += `<button class="filter-btn" id="tf-${t}" onclick="setTypeFilter('${t}')">${t}</button>`);
  wrap.innerHTML = h;
}
function setTypeFilter(t) {
  typeFilter = t;
  document.querySelectorAll('#typeFilters .filter-btn').forEach(b=>b.classList.remove('active'));
  document.getElementById(t ? `tf-${t}` : 'tf-all').classList.add('active');
  render();
}
function toggleStatus(s) {
  statusFilter = statusFilter === s ? null : s;
  document.getElementById('btnActive').className = 'status-btn' + (statusFilter==='active'?' active-filter':'');
  document.getElementById('btnInactive').className = 'status-btn' + (statusFilter==='inactive'?' inactive-filter':'');
  render();
}

// ── EMAIL FIELDS ─────────────────────────────────────
function renderEmailFields(emails) {
  const list = document.getElementById('email-list');
  list.innerHTML = '';
  (emails.length ? emails : ['']).forEach((e) => {
    const row = document.createElement('div');
    row.className = 'email-row';
    row.innerHTML = `<input class="form-input" placeholder="email@media.com" value="${e}"><button class="btn-remove-email" onclick="removeEmailField(this)">✕</button>`;
    list.appendChild(row);
  });
}
function addEmailField() {
  const list = document.getElementById('email-list');
  const row = document.createElement('div');
  row.className = 'email-row';
  row.innerHTML = '<input class="form-input" placeholder="email@media.com"><button class="btn-remove-email" onclick="removeEmailField(this)">✕</button>';
  list.appendChild(row);
}
function removeEmailField(btn) {
  const list = document.getElementById('email-list');
  if (list.children.length > 1) btn.parentElement.remove();
  else btn.previousElementSibling.value = '';
}
function getEmailValues() {
  return [...document.querySelectorAll('#email-list .email-row input')].map(i=>i.value.trim()).filter(v=>v && v.includes('@'));
}

// ── EDIT MODAL ───────────────────────────────────────
function updateMediaDatalist() {
  const names = [...new Set(data.map(d=>d.mediaName))].sort((a,b)=>a.localeCompare(b,'ko'));
  document.getElementById('media-datalist').innerHTML = names.map(n=>`<option value="${n}">`).join('');
}
function openAddModal() {
  editingId = null;
  document.getElementById('modalTitle').textContent = '기자 추가';
  document.getElementById('f-type').value = '종합지';
  document.getElementById('f-media').value = '';
  document.getElementById('f-dept').value = '';
  document.getElementById('f-name').value = '';
  document.getElementById('f-phone').value = '';
  document.getElementById('f-date').value = new Date().toISOString().slice(0,10);
  setSendVal('f-emailSend', false, 'on-email');
  setSendVal('f-smsSend', false, 'on-sms');
  document.getElementById('f-memo').value = '';
  renderEmailFields([]);
  updateMediaDatalist();
  document.getElementById('editModal').style.display = 'flex';
}
function openEditModal(id) {
  editingId = id;
  const j = data.find(d=>d.id===id);
  if (!j) return;
  document.getElementById('modalTitle').textContent = '기자 정보 편집';
  document.getElementById('f-type').value = j.mediaType;
  document.getElementById('f-media').value = j.mediaName;
  document.getElementById('f-dept').value = j.dept;
  document.getElementById('f-name').value = j.name;
  document.getElementById('f-phone').value = j.phone;
  document.getElementById('f-date').value = '';
  setSendVal('f-emailSend', j.emailSend, 'on-email');
  setSendVal('f-smsSend', j.smsSend, 'on-sms');
  document.getElementById('f-memo').value = j.memo||'';
  renderEmailFields(j.emails||[]);
  updateMediaDatalist();
  document.getElementById('editModal').style.display = 'flex';
}
function closeEditModal() { document.getElementById('editModal').style.display = 'none'; }

async function saveJournalist() {
  const name = document.getElementById('f-name').value.trim();
  if (!name) { alert('기자명을 입력하세요.'); return; }
  
  showLoading('데이터를 구글 시트에 저장하는 중입니다...');
  
  const emails = getEmailValues();
  let targetData = null;
  let actionStr = 'add';

  if (editingId) {
    actionStr = 'edit';
    targetData = data.find(d=>d.id===editingId);
    targetData.mediaType = document.getElementById('f-type').value;
    targetData.mediaName = document.getElementById('f-media').value.trim();
    targetData.dept = document.getElementById('f-dept').value.trim();
    targetData.name = name; targetData.emails = emails;
    targetData.phone = document.getElementById('f-phone').value.trim();
    targetData.emailSend = getSendVal('f-emailSend');
    targetData.smsSend = getSendVal('f-smsSend');
    targetData.memo = document.getElementById('f-memo').value.trim();
  } else {
    const date = document.getElementById('f-date').value;
    targetData = {
      id: nextId++, sheet: '신규', sheetOrder: 99, mediaOrder: 9999,
      mediaType: document.getElementById('f-type').value,
      mediaName: document.getElementById('f-media').value.trim(),
      dept: document.getElementById('f-dept').value.trim(),
      name, emails, phone: document.getElementById('f-phone').value.trim(),
      active: true,
      emailSend: getSendVal('f-emailSend'),
      smsSend: getSendVal('f-smsSend'),
      memo: document.getElementById('f-memo').value.trim(),
      date, history: date ? [{type:'join', date, note:'최초 등록'}] : []
    };
    data.push(targetData);
  }

  await saveToGoogleSheet(actionStr, targetData);

  closeEditModal(); 
  render();
  hideLoading();
  showToast(editingId ? `${name} 정보 업데이트됨` : `${name} 추가됨`);
}

// ── HISTORY MODAL ────────────────────────────────────
function openHistModal(id) {
  histEditingId = id;
  const j = data.find(d=>d.id===id);
  if (!j) return;
  document.getElementById('histModalTitle').textContent = `${j.name} · 출입 이력`;
  document.getElementById('h-date').value = new Date().toISOString().slice(0,10);
  document.getElementById('h-note').value = '';
  renderHistEntries(j);
  document.getElementById('histModal').style.display = 'flex';
}
function renderHistEntries(j) {
  const wrap = document.getElementById('histEntries');
  if (!(j.history||[]).length) { wrap.innerHTML = '<div style="color:var(--text3);text-align:center;padding:16px;font-size:13px">이력 없음</div>'; return; }
  wrap.innerHTML = (j.history||[]).map((h,i) => `
    <div class="hist-modal-entry">
      <span class="hist-dot ${h.type==='join'?'dot-join':'dot-leave'}"></span>
      <span class="hist-date">${h.date}</span>
      <span class="hist-type-label ${h.type==='join'?'type-join':'type-leave'}">${h.type==='join'?'출입':'제외'}</span>
      <span class="hist-note">${h.note||''}</span>
      <button class="icon-btn" onclick="removeHist(${i})" style="width:22px;height:22px;font-size:10px;margin-left:auto">✕</button>
    </div>`).join('');
}
async function removeHist(idx) {
  const j = data.find(d=>d.id===histEditingId); if (!j) return;
  
  showLoading('이력을 삭제하고 구글 시트에 반영 중입니다...');
  
  j.history.splice(idx,1); 
  await saveToGoogleSheet('edit', j);
  
  renderHistEntries(j);
  render();
  hideLoading();
}
async function addHistEntry() {
  const j = data.find(d=>d.id===histEditingId); if (!j) return;
  const type = document.getElementById('h-type').value;
  const date = document.getElementById('h-date').value;
  if (!date) { alert('날짜를 입력하세요.'); return; }
  const note = document.getElementById('h-note').value.trim();
  
  showLoading('새 이력을 추가하고 구글 시트에 반영 중입니다...');
  
  j.history = j.history || [];
  j.history.push({type, date, note});
  j.history.sort((a,b)=>a.date.localeCompare(b.date));
  const last = j.history[j.history.length-1];
  j.active = last.type === 'join';
  document.getElementById('h-note').value = '';
  
  await saveToGoogleSheet('edit', j);
  
  renderHistEntries(j);
  render();
  hideLoading();
  showToast('이력 추가됨');
}
function closeHistModal(doRender) {
  document.getElementById('histModal').style.display = 'none';
  if (doRender) render();
}

function toggleSend(id, cls) {
  document.getElementById(id).classList.toggle(cls);
}
function getSendVal(id) {
  const btn = document.getElementById(id);
  return btn.classList.contains('on-email') || btn.classList.contains('on-sms');
}
function setSendVal(id, val, cls) {
  document.getElementById(id).classList.toggle(cls, !!val);
}

// ── 초기화 실행 ─────────────────────────────────────
// 화면 렌더링을 멈추고 서버에서 데이터를 먼저 불러옵니다.
loadData();
</script>
</body>
</html>





